<!DOCTYPE html>
<html ng-app="app">
<head>
    <title>后台管理</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="libs/bootstrap-3.3.5/css/bootstrap.min.css">
    <link href="stylesheets/style.css" rel="stylesheet" />
    <script type="text/javascript" src="libs/jquery-1.11.3.js"></script>
    <script type="text/javascript" src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="libs/angularjs/1.4.3/angular.js"></script>
    <script type="text/javascript" src="libs/angularjs/1.4.3/angular-route.js"></script>
    <script type="text/javascript" src="libs/angularjs/1.4.3/angular-resource.js"></script>
    <!--<script type="text/javascript" src="libs/angularjs/1.4.3/angular.min.js"></script>
    <script type="text/javascript" src="libs/angularjs/1.4.3/angular-route.min.js"></script>
    <script type="text/javascript" src="libs/angularjs/1.4.3/angular-resource.min.js"></script>-->
    <script type="text/javascript" src="libs/angularjs/1.4.3/angular-cookies.js"></script>
</head>
<body ng-controller="UserController" ng-init="init()">
    <div ng-show="!isLogin">
        请先登录，然后进入个人空间。<a href="index.html">登录</a>
    </div>
    <div ng-show="isLogin">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="#">Brand</a>
                </div>

                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="index.html">交易场</a></li>
                        <li><a href="#">{{user.alias}}</a></li>
                    </ul>

                </div><!-- /.navbar-collapse -->
            </div><!-- /.container-fluid -->
        </nav>
        <!-- http://getbootstrap.com/css/ Stacked-to-horizontal-->
        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-2 col-md-2">
                    <ul class="nav nav-stacks">
                        <li role="presentation"><a href="#userManage">管理用户</a></li>
                        <li role="presentation"><a href="#assetSheetManage">管理发布资产</a></li>
                        <li role="presentation"><a href="#offerManage">管理资产竞价</a></li>
                        <li role="presentation"><a href="#ticketManage">管理订单</a></li>
                    </ul>
                </div>
                <div class="col-xs-10 col-md-10">
                    <div ng-view>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        var app = angular.module('app', ['ngRoute', 'ngResource', 'ngCookies']);

        app.config(function ($routeProvider) {
            $routeProvider
                .when('/userManage', {
                    templateUrl: 'pages/admin/userManage.html',
                    controller: 'userManageController'
                })
                .when('/assetSheetManage', {
                    templateUrl: 'pages/admin/assetManage.html',
                    controller: 'assetSheetManageController'
                })
                .when('/offerManage', {
                    templateUrl: 'pages/admin/offerManage.html',
                    controller: 'offerManageController'
                })
                .when('/ticketManage', {
                    templateUrl: 'pages/admin/ticketManage.html',
                    controller: 'ticketManageController'
                })
                .when('/assetSheets/:id', {
                    templateUrl: 'pages/admin/asset.html',
                    controller: 'assetSheetDetailController'
                })
                .when('/offers/:id', {
                    templateUrl: 'pages/admin/offerDetail.html',
                    controller: 'offerDetailController'
                })
                 .when('/offerItem/:id', {
                     templateUrl: 'pages/admin/offerManage.html',
                     controller: 'offerItemDetailController'
                 })
                .otherwise({
                    // when all else fails
                    templateUrl: 'pages/routeNotFound.html',
                    controller: 'notFoundController'
                });;
        });

        app.controller('UserController', function ($scope, $cookieStore, $window, $rootScope) {
            $scope.init = function () {
                var user = $cookieStore.get("user");
                if (user) {
                    $scope.user = user;
                    $rootScope.user = user;
                    $scope.isLogin = true;
                }
                else {
                    // redirect to index.html
                    //$window.location.href = "index.html";
                }
            }
        })

             .factory('Users', ['$resource', function ($resource) {
                 return $resource('/api/users/:id', null, {
                     'update': { method: 'PUT' }
                 });
             }])

            .controller('userManageController', ['$scope', 'Users', function ($scope, Users) {
                $scope.users = Users.query();

                $scope.DisableUser = function ($uid, $index) {
                    var user = new Users({ status: 3 });
                    Users.update({ id: $uid }, user);
                    $scope.users = Users.query();
                }

                $scope.EnableUser = function ($uid, $index) {
                    var user = new Users({ status: 1 });
                    Users.update({ id: $uid }, user);
                    $scope.users = Users.query();
                    //$scope.users[$index].status = 1;
                }

                $scope.LockUser = function ($uid, $index) {
                    var user = new Users({ status: 2 });
                    Users.update({ id: $uid }, user);
                    $scope.users = Users.query();
                    //$scope.users[$index].status = 2;
                }
            }])

        .factory('AssetSheets', ['$resource', function ($resource) {
            return $resource('/api/assetSheets/:id', null, {
                'update': { method: 'PUT' }
            });
        }])

         .controller('assetSheetManageController', ['$scope', 'Users', 'AssetSheets', function ($scope, Users, AssetSheets) {
             $scope.assetSheets = AssetSheets.query(null, function (data) {
                 for (i = 0; i < $scope.assetSheets.length; ++i) {
                     var uid = $scope.assetSheets[i].createdById;
                     $scope.assetSheets[i].user = Users.query({ _id: uid });
                 }
             });

             $scope.DisableAsset = function ($aid) {
                 var asset = new Assets({ status: 4 });
                 Assets.update({ id: $aid }, asset);
                 $scope.assets = Assets.query();
             }

             $scope.EnableAsset = function ($aid) {
                 var asset = new Assets({ status: 3 });
                 Assets.update({ id: $aid }, asset);
                 $scope.assets = Assets.query();
             }
         }])

         .controller('assetSheetDetailController', ['$scope', '$routeParams', 'AssetSheets', '$location', function ($scope, $routeParams, AssetSheets, $location) {
             $scope.assetSheet = AssetSheets.get({ id: $routeParams.id });
         }])

          .factory('Offers', ['$resource', function ($resource) {
              return $resource('/api/offers/:id', null, {
                  'update': { method: 'PUT' }
              });
          }])

         .controller('offerManageController', ['$scope', 'AssetSheets', 'Offers', function ($scope, AssetSheets, Offers) {
             $scope.offers = Offers.query(null, function (data) {
                 for (i = 0; i < $scope.offers.length; ++i) {
                     var sid = $scope.offers[i].sheetId;
                     console.log(sid);
                     $scope.offers[i].assetSheet = AssetSheets.query({ _id: sid });
                 }
             });

             $scope.DisableBid = function ($offer) {
                 var offer = new Offers({ status: 0 });
                 Offers.update({ id: $offer }, offer);
                 $scope.offers = Offers.query();
             }

             $scope.EnableBid = function ($offer) {
                 var offer = new Offers({ status: 1 });
                 Offers.update({ id: $offer }, offer);
                 $scope.offers = Offers.query();
             }

         }])

        .controller('offerDetailController', ['$scope', 'AssetSheets', '$routeParams', 'Offers', '$location', function ($scope, AssetSheets, $routeParams, Offers, $location) {
            $scope.offer = Offers.query({ _id: $routeParams.id }, function (data) {
                var sid = data[0].sheetId;
                var sheet = AssetSheets.query({ _id: sid });
                $scope.offer.assetss = sheet;
                console.log($scope.offer.assetss);

                //for (i = 0; i < data.assets.length; ++i) {
                //    $scope.offer.assets[i].price = data[0].assets[i].price;
                //}
            });
        }])

     .controller('offerItemDetailController', ['$scope', '$routeParams', 'Offers', '$location', function ($scope, $routeParams, Offers, $location) {
         $scope.offers = Offers.query({ _id: $routeParams.id });
     }])

         .factory('Tickets', ['$resource', function ($resource) {
             return $resource('/api/tickets/:id', null, {
                 'update': { method: 'PUT' }
             });
         }])

         .controller('ticketManageController', ['$scope', 'Tickets', function ($scope, Tickets) {
             $scope.closeTickets = Tickets.query({ status: 2 });
             $scope.pendingTickets = Tickets.query({ status: 1 });

             $scope.DisableTicket = function ($tid) {
                 var ticket = new Tickets({ status: 2 });
                 Tickets.update({ id: $tid }, ticket);
                 $scope.closeTickets = Tickets.query({ status: 2 });
                 $scope.pendingTickets = Tickets.query({ status: 1 });
             }

             $scope.EnableTicket = function ($tid) {
                 var ticket = new Tickets({ status: 1 });
                 Tickets.update({ id: $tid }, ticket);
                 $scope.closeTickets = Tickets.query({ status: 2 });
                 $scope.pendingTickets = Tickets.query({ status: 1 });
             }

         }])

    </script>
</body>
</html>
